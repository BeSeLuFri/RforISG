---
title: "Datamanagement: Eurostat Example"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
```


# General and Setup
   
## General Coding Information
* Retrieve and manage data for the PES project directly via the Eurostat API and the related eurostat R package 
* Links: [eurostat Cheat Sheet](https://github.com/rstudio/cheatsheets/raw/master/eurostat.pdf) and  [eurostat Documentation](https://cran.r-project.org/web/packages/eurostat/eurostat.pdf)
* There is a minor bug when working with R_Notebook on the old ISG Windows environments. In case you get the error: "Error creating notebook: pandoc document conversion failed with error 11" just apply [this fix](https://github.com/rstudio/rstudio/issues/3661#issuecomment-475705806) from kevinushey (22 Mar 2019). 
  + When executing code within R Markdown or a plain script this is no problem at all
* New (obvious) Learning for BF: Never use warning=FALSE in code chunks when working in a R_Notebook --> otherwise you won't see warnings (surprise, surprise!). I wasted 3h today bc I wasn't aware of the warnings....   

## Important Data Management Decisions
* For Belgium regions the following geo identifiers have been used
  + **BE1** Région de Bruxelles-Capitale / Brussels Hoofdstedelijk Gewest --> ATTENTION BE10 seems to be identical
  + **BE2** Vlaams Gewest
  + **BE3** Région wallonne
* Youth and working age population
  + Youth defined as "From 15 to 24 years"
  + Working age populations as "From 15 to 64 years",
  
## Different Data Sources used than in 2018
* Unemployment rates for Belgium are not only from lfst_r_lfu3rt anymore but are split into   
  + lfst_r_lfur2gac has 15-64
  + lfst_r_lfu3rt has 15-24
* Employment rates:
  + lfsa_ergaed used instead of lfsa_ergaedn (no citizenship)
* Employment rate by sex and age - Belgium
  + There is only data for the working age population
* Employment growth can be computed for Belgium regions, too 
  + because we have the data: lfst_r_lfe2emp
* Nominal GDP per capita
  + We use Gross domestic product at market prices	tec00001
* Literacy BE:
  + Different Dataset which includes age group  age group 15-65 (which edat_lfse_04 didn't)
* Excel List Variable No 41 pop_working_age --> no data sheet existent for this variable; plus we already have it in population
* Variable No4 seasonal employment not available
* In excel list from 2018, we also have a data sheet on "Part-time employment and temporary contracts - annual data  [lfsi_pt_a]"
  + However, this is very similiar to "Temporary employees as percentage of the total number of employees, by sex, age and citizenship (%) [lfsa_etpgan]" --> which we also have in the excel list but on sheet 1 (the variable overview)
  + Only difference is that the former is  connected to all types of employment while the latter is only related to the number of employees as numeraire
  + No important difference, only using the first type of variable 
* Minimum Wage: There are two additional variables in the excel list: minwage WSI and minwage (binary)
  + the former is identical to the eurostat minimum wage variable, just in hourly earnings not monthly --> no difference between the two variables
  + the latter is a binary variable which is time constant --> can't use it because of the lack of time variance
* Shadow economy Schneider: Please - let's not use this b****it variable
* Strictness of dismissal protection law: No data after 2013 --> excluded accordingly
* I have no access to "Tax rate on labour as % of total labour costs (OECD)" --> needs to be purchased retrieved with professional account
* Replacement Rate Unemployment benefits: data different from the data in excel file
* Benefit duration in months (can't use it because no time variance)



  
## The data management structure
* Each variable/group of related variables has its own header and is being downloaded and manipulated in the same fashion:
  + There are three code chunks: one for a) all countries, b) Belgian regions and c) merging a and b
* a) and b) themselves have the same order:
  + Download data via API with get_eurostat
  + Label all codes (for easier readability) with label_eurostat
  + Filter, Select and Spread the data
* The first data group (Employment) has extensive comments do ease the understanding of the code
* To retrieve the eurostat codes for datasets check the subchapter Search for Eurostat codes
  

## Load packages
* If you haven't done so already, install all the packages below with install.packages("packagename") 
```{r,message=FALSE, warning=FALSE}
library(tidyverse) # the state of the art system of packages for data manipulation, exploration and visualization with a a coherent design philosophy
library(eurostat) # the propietary eurostat package for retrieving and manipulating Eurostat data
```


## Clean Environment/Cache 
* Eurostat saves all the data we download via the eurostat package in C:\Users\Username\Temp and reloads them from there every time you rerun the get_eurostat function
  + This might lead to datasets remaining "unupdated" if we accidentially reload the data from local user and not the API. 
  + therefore, always run clean_eurostat_cache() before new sessions
```{r, message=FALSE}
rm(list = ls()) # The standard environment cleaner for your R environment
# clean_eurostat_cache() # see bullet points above 
```

## Search for Eurostat codes
* Eurostat codes for data tables can be retrieved via search_eurostat
* An example (looking for all data containing the name employment in the title):
```{r, message=FALSE}
query <- search_eurostat("Employment",
                         type = "all") # inspect query via View(query)
```


# Employment rate by educational attainment levels
## Countries: **lfsa_ergaed** Employment rates by sex, age and educational attainment level 
```{r, message=FALSE}
data_a <-
  get_eurostat(id = "lfsa_ergaed", # the relevant id to be downloaded
               time_format = "num") # retrieve time column as.numeric right away (bc we only have yearly data)
               
data_a <- label_eurostat(data_a,
                           code = c("geo",
                                    "isced11",
                                    "sex"), # we want to keep the "geo" plus relevant identifier items to be able to merge data easily
                           lang = "en") # English is the default, line included for transparency

data_a <- data_a %>%
  filter(age == "From 15 to 64 years",
         # filter for appropriate values --> if more variables (for example sex or age) are needed, make changes here!
         isced11_code %in% c("ED0-2", "ED3_4", "ED5-8")) %>%
  mutate(
    variab = "emp", # Add variable identifier
    isced11_code = str_replace(isced11_code, "-", "_"),
    # R doesn't like '-'(minus) in column names, change that to '_'
    key = paste(variab, isced11_code, sex_code, sep = "_")
  ) %>% # Merge sex and isced to get different data vars
  select(-c(unit, sex, isced11, sex_code, isced11_code, age, geo)) %>% # remove unnecessary rows (which would be in the way of spread)
  spread(key = key, value = values) %>% # spread out the column whose individual levels are needed as columns
  rename_all(tolower) # all column names in lowercase
  

```

## Belgium: **lfst_r_lfe2emprtn** Employment rates by sex, age, educational attainment level, citizenship and NUTS 2 regions
```{r, message=FALSE}
data_b <-
  get_eurostat(id = "lfst_r_lfe2emprtn", # the relevant id to be downloaded
               time_format = "num") # retrieve time column as.numeric right away (bc we only have yearly data)


data_b <- label_eurostat(
  data_b,
  code = c("geo",
           "isced11",
           "sex"),
  # we want to keep the "geo" and "na_item" column to be able to merge data easily
  lang = "en",
  # English is the default, line included for transparency
  fix_duplicated = TRUE
)

data_b <- data_b %>%
  filter(
    geo_code %in% c("BE1", "BE2", "BE3"),
    citizen == "Total", # geo_code and citizen are the only two differences in Belgium compared to Country level for the filter
    age == "From 15 to 64 years",
    # filter for appropriate values --> if more variables (for example sex or age) are needed, make changes here!
    isced11_code %in% c("ED0-2", "ED3_4", "ED5-8")
  ) %>%
  mutate(
    variab = "emp", # Add variable identifier
    isced11_code = str_replace(isced11_code, "-", "_"),
    # R doesn't like '-'(minus) in column names, change that to '_'
    key = paste(variab, isced11_code, sex_code, sep = "_")
  ) %>% # Merge sex and isced to get different data vars
  select(-c(unit, sex, isced11, sex_code, isced11_code, age, geo, citizen)) %>% # remove unnecessary rows (which would be in the way of spread) + Do not forget also to unfilter citizen (extra variable in the Belgium data)
  spread(key = key, value = values) %>% # spread out the column whose individual levels are needed as columns
  rename_all(tolower) # all column names in lowercase


```

## Rbind a and b
```{r, message=FALSE}
empl_educ <- rbind(data_a, data_b)
```


# Replacement Rate of last earnings before unemployment
* From OECD
* https://stats.oecd.org/Index.aspx?DataSetCode=NRR#_ga=2.115968198.1529179679.1559572370-478591159.1556266530
* Which time --> data different from the data in excel file ToDo @HV
```{r, message=FALSE}
# reprate <- read_csv("2019/orig/test/Replacement Rate last earnings.csv")
```


# Left over for Hans
* Share of self-employed (Var no 53)
* Duration of working life (Var no 54)





+++++++++++++++++++++

# Merge all df together and save as csv
```{r, message=FALSE}

# df_final <-
#   Reduce(
#     function(x, y)
#       full_join(x, y, by = c("geo_code", "time")),
#     list(empl_educ, unempl, empl_sex_age, transition, empl_growth, totemp, gdp_gr, gdp_pc, inv, min_wage, empsize, dropout,  
#          literacy, childcare, gr_productiv, popul, depratio, immigr, emmigr, tempemp, jobsrch, activtyrate, parttime, death)
#   )
# 
# df_final <- df_final %>%
#   group_by(geo_code, time) %>%
#   rename_all(tolower)

# write_excel_csv2(df_final, "data_uptodate.csv")
```

